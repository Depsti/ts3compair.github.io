<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ICAO Checklist</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --font-ui: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font-head: "Rajdhani", "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#111;
      --muted:#555;
      --border:#e9e9e9;
      --row:#f0f0f0;
      --shadow:0 2px 10px rgba(0,0,0,.06);
      --btn-bg:#fff;
      --btn-border:#ddd;
      --btn-hover:#fafafa;
      --danger-hover:#fff3f3;
      --danger-border:#ffd5d5;
      --focus:#f7f7f7;
      --subcard:#fbfbfb;
      --chip-bg:#f1f3f6;
      --chip-border:#dfe3ea;
      --input-bg:#fff;
      --input-border:#ddd;
    }

    html[data-theme="dark"]{
      --bg:#0f1115;
      --card:#161a22;
      --text:#e9eef7;
      --muted:#a8b0bf;
      --border:#262c38;
      --row:#232a36;
      --shadow:0 8px 26px rgba(0,0,0,.45);
      --btn-bg:#1b2030;
      --btn-border:#2a3345;
      --btn-hover:#202741;
      --danger-hover:#2a1416;
      --danger-border:#5a2a2e;
      --focus:#1f2536;
      --subcard:#141826;
      --chip-bg:#1f2536;
      --chip-border:#2a3345;
      --input-bg:#1b2030;
      --input-border:#2a3345;
    }

    body{
      font-family:var(--font-ui);
      background:var(--bg);
      color:var(--text);
      padding:20px;
      margin:0;
    }

    /* Container */
    .container{max-width:1400px;margin:0 auto}

    h1{
      font-family: var(--font-head);
      font-weight:700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      margin:0 0 14px;
      color:var(--text)
    }

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;
      margin:0 0 14px;align-items:center;
    }

    button{
      font-family: var(--font-ui);
      font-weight: 600;

      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      box-shadow:var(--shadow);
      white-space:nowrap;
    }
    button:hover{background:var(--btn-hover)}


    .toolbar-spacer{flex:1}

    .icon-btn{
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      border-radius:12px;
      width:44px;
      height:44px;
      padding:0;
      cursor:pointer;
      box-shadow:var(--shadow);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      line-height:1;
    }
    .icon-btn:hover{background:var(--btn-hover)}

    .icon-btn{position:relative}
    .badge{
      position:absolute;
      right:8px;
      bottom:8px;
      width:8px;
      height:8px;
      border-radius:999px;
      background: var(--chip-border);
      opacity: 0;
      transform: scale(.8);
      transition: opacity .15s ease, transform .15s ease;
    }
    .badge.on{opacity:1;transform:scale(1)}

    .toolbar-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .member-display{
      display:none;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
      box-shadow:var(--shadow);
      font-family: var(--font-mono);
      letter-spacing:.4px;
      font-size:12px;
      text-transform:uppercase;
      max-width:220px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .member-display.on{display:inline-flex}

    .toast{
      position:fixed;
      top:16px;
      right:16px;
      min-width:220px;
      max-width:min(360px, calc(100vw - 32px));
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      opacity:0;
      transform: translateY(-8px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 10000;
    }
    .toast.show{
      opacity:1;
      transform: translateY(0);
    }

    .text-input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      box-shadow: var(--shadow);
      font-family: var(--font-mono);
      letter-spacing: .4px;
    }
    .text-input:focus{background: var(--focus)}
    .text-area{
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      box-shadow: var(--shadow);
      font-family: var(--font-mono);
      letter-spacing: .4px;
      line-height: 1.35;
    }
    .text-area:focus{background: var(--focus)}

    .inline-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .inline-row .grow{flex:1 1 260px; min-width: 220px;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }

    .btn-row{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top: 4px;
    }
    .error{
      color: #b00020;
      font-size: 13px;
    }
    html[data-theme="dark"] .error{color:#ff8080}


    /* Settings modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.45);
      z-index: 10000;
      padding: 18px;
    }
    .modal.open{display:flex}
    .modal-card{
      width: min(520px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      /* Keep the modal within the viewport; content scrolls inside the body */
      max-height: calc(100dvh - 36px);
      display: flex;
      flex-direction: column;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title{
      font-family: var(--font-head);
      font-weight:700;
      letter-spacing: 0.7px;
      text-transform: uppercase;
      font-size: 18px;
    }
    .modal-body{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      /* Scroll long content (e.g. Compare results) inside the modal */
      overflow: auto;
      flex: 1 1 auto;
      overscroll-behavior: contain;
    }
    .setting-row{
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--subcard);
    }
    .setting-toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 800;
      user-select:none;
    }
    .setting-toggle input{transform: scale(1.05)}
    .setting-desc{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .divider{
      height: 1px;
      background: var(--border);
      border-radius: 1px;
      margin: 2px 0;
    }
    body.modal-open{overflow:hidden}

    button:disabled{opacity:.55;cursor:not-allowed}

    .hint{color:var(--muted);font-size:14px;margin:0 0 18px}
    .small{font-size:12px;color:var(--muted)}

    /* Search */
    .searchbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:0 0 14px;
    }
    .searchbar input{
      flex: 1 1 260px;
      max-width: 420px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--input-border);
      background:var(--input-bg);
      color:var(--text);
      outline:none;
      box-shadow:var(--shadow);
      font-family: var(--font-mono);
      letter-spacing:.4px;
      text-transform: uppercase;
    }
    .search-info{
      color:var(--muted);
      font-size:13px;
    }

    /* Cards */
    .category{
      background:var(--card);
      border-radius:12px;
      padding:14px 14px 10px;
      margin-bottom:14px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }

    .cat-head{
      display:flex;align-items:center;gap:10px;
      justify-content:space-between;margin-bottom:12px;
    }

    .cat-title{
      font-family: var(--font-head);
      font-size:20px;
      font-weight:700;
      letter-spacing: 0.4px;
      border:none;outline:none;
      width:100%;background:transparent;color:var(--text);
    }

    .cat-actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Collapsible (continents & countries) */
    .collapse-btn{
      width:34px;
      height:34px;
      padding:0;
      border-radius:10px;
      box-shadow:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      line-height:1;
    }
    .collapse-btn .chev{
      display:inline-block;
      transition:transform .15s ease;
    }
    .collapsed .collapse-btn .chev{
      transform: rotate(-90deg);
    }
    .collapsible-body{
      margin-top: 4px;
    }
    .collapsed .collapsible-body{
      display:none;
    }
    .meta-pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      background:var(--subcard);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
      user-select:none;
    }


    .subcat{
      background:var(--subcard);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin:12px 0;
    }
    .subcat-head{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .subcat-title{
      font-family: var(--font-head);
      font-size:16px;
      font-weight:600;
      letter-spacing: 0.25px;
      border:none;
      outline:none;
      width:100%;
      background:transparent;
      color:var(--text);
    }
    .subcat-actions{display:flex;gap:8px;flex-wrap:wrap}

    .item{
      display:grid;
      grid-template-columns:24px 1fr auto;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-top:1px solid var(--row);
    }
    .item:first-of-type{border-top:none}

    .item-text{
      border:none;outline:none;background:transparent;
      padding:6px 4px;border-radius:8px;color:var(--text);
      font-family: var(--font-mono);
      letter-spacing: .4px;
      text-transform: uppercase;
    }
    .item-text:focus{background:var(--focus)}

    .delete-btn{
      border:1px solid var(--border);
      background:var(--btn-bg);
      color:var(--text);
      border-radius:10px;
      padding:6px 10px;
      cursor:pointer;
      box-shadow:none;
    }
    .delete-btn:hover{
      background:var(--danger-hover);
      border-color:var(--danger-border);
    }

    .mode,.toggle{display:flex;align-items:center;gap:8px;color:var(--text)}
    .mode{margin-left:auto}

    /* Footer / results */
    .footerbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:18px 0 10px;
    }

    .results-title{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .results-title h2{
      margin:0;
      font-size:18px;
    }
    .results-meta{
      color:var(--muted);
      font-size:13px;
    }

    /* Grid */
    .results-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    @media (min-width: 1200px){
      .results-grid{
        grid-template-columns: repeat(3, minmax(320px, 1fr));
      }
    }
    @media (max-width: 760px){
      .results-grid{
        grid-template-columns: 1fr;
      }
    }

    
    /* Compare output inside Settings modal */
    .modal-card .results-grid{
      grid-template-columns: 1fr;
    }
    .compare-note{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
.country-card{
      background: var(--subcard);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
    }
    .country-card-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:8px;
    }
    .country-card-head .name{
      font-family: var(--font-head);
      font-weight:700;
      letter-spacing: 0.25px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
      font-family: var(--font-mono);
      letter-spacing:.4px;
      font-size:13px;
      user-select:text;
    }

    .empty{
      color:var(--muted);
      padding:10px 0 6px;
    }

    .jump-highlight{
      outline: 2px solid rgba(255, 200, 0, 0.8);
      border-radius: 10px;
      animation: pulse 1.2s ease-in-out 0s 2;
    }
    @keyframes pulse {
      0%   { outline-color: rgba(255, 200, 0, 0.0); }
      50%  { outline-color: rgba(255, 200, 0, 0.9); }
      100% { outline-color: rgba(255, 200, 0, 0.0); }
    }

    .scroll-fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    }
    .scroll-fab button{
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
    }
  </style>
</head>

<body>
  <div class="container" id="top">
    <h1>ICAO Codes ‚Äì Continent ‚Üí Country</h1>

    <div class="toolbar">
      <button id="addCategoryBtn">+ Add continent</button>
      <button id="resetBtn" title="Resets everything to the initial state">‚Ü∫ Reset</button>

      <div class="toolbar-spacer"></div>

      <div class="toolbar-right">
      <button id="memberBtn" class="icon-btn" type="button" title="Set memberID" aria-haspopup="dialog" aria-expanded="false">üë§<span id="memberBadge" class="badge" aria-hidden="true"></span></button>
      <span id="memberDisplay" class="member-display" aria-live="polite"></span>
      <button id="settingsBtn" class="icon-btn" type="button" title="Settings" aria-label="Settings" aria-haspopup="dialog" aria-expanded="false">‚öôÔ∏è</button>
      <a id="roomsLink" class="icon-btn" href="rooms.html" title="Multiplayer rooms" aria-label="Multiplayer rooms">üë•</a>

    </div>
    </div>

    <div class="searchbar">
      <input id="searchInput" type="text" placeholder="Search ICAO here ‚Ä¶" autocomplete="off" />
      <button id="searchBtn">Search</button>
      <button id="nextBtn" class="delete-btn" title="Next Match">Next</button>
      <button id="prevBtn" class="delete-btn" title="Previous Match">Back</button>
      <span class="search-info" id="searchInfo"></span>
    </div>


    <div id="app"></div>

    <div class="footerbar">
      <button id="submitBtn">Submit</button>
      <button id="hideResultsBtn" class="delete-btn" style="display:none;">Hide results</button>
      <span class="results-meta" id="selectedCountText"></span>
    </div>

    <div id="results"></div>
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="settingsTitle">
      <div class="modal-card" role="document">
        <div class="modal-head">
          <div class="modal-title" id="settingsTitle">Settings</div>
          <button id="settingsCloseBtn" class="icon-btn" type="button" title="Close" aria-label="Close settings">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="setting-row">
            <label class="setting-toggle">
              <input type="checkbox" id="viewModeToggle">
              <span>Read-only</span>
            </label>
            <div class="setting-desc">Disable editing (checkboxes and text inputs become read-only).</div>
          </div>

          <div class="setting-row">
            <label class="setting-toggle">
              <input type="checkbox" id="darkModeToggle">
              <span>Dark Mode</span>
            </label>
            <div class="setting-desc">Switch between light and dark theme.</div>
          </div>

          
          <div class="divider"></div>

          <div class="setting-row">
            <div class="setting-desc" style="font-weight:900; color: var(--text);">Transfer selection</div>
            <div class="setting-desc">Create a compact code for your current selection and share it with others. You can also paste a code to apply it to your checklist.</div>
          </div>

          <div class="setting-row">
            <div class="inline-row">
              <input id="shareCodeOut" class="text-input grow" type="text" readonly placeholder="Share code will appear here‚Ä¶" />
              <button id="shareRefreshBtn" type="button" class="delete-btn" title="Regenerate / update">Update</button>
              <button id="shareCopyBtn" type="button" title="Copy code">Copy</button>
            </div>
            <div class="inline-row" style="margin-top:8px;">
              <span id="shareMeta" class="pill">‚Äî</span>
            </div>
          </div>

          <div class="setting-row">
            <textarea id="shareCodeIn" class="text-area" placeholder="Paste a share code here‚Ä¶"></textarea>
            <div class="btn-row">
              <button id="shareApplyMergeBtn" type="button" class="delete-btn" title="Mark airports from code as owned, keep your other checks">Apply (merge)</button>
              <button id="shareCompareBtn" type="button" title="Show common airports between your selection and the pasted code">Compare</button>
              <button id="shareApplyReplaceBtn" type="button" title="Replace your current checkmarks with the code">Apply (replace)</button>
            </div>
            <div class="setting-desc">Tip: ‚ÄúReplace‚Äù clears your current checkmarks first. Imported airports not found in your list will be added under <b>Imported ‚Üí Unknown</b>.</div>
            <div id="shareCompareOut" style="display:none; margin-top:10px;"></div>
          </div>

          <div class="divider"></div>

          <div class="setting-row">
            <div class="setting-desc">More settings will come later.</div>
          </div>

        </div>
      </div>
    </div>


    
    <!-- MemberID Modal -->
    <div id="memberModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="memberTitle">
      <div class="modal-card" role="document">
        <div class="modal-head">
          <div class="modal-title" id="memberTitle">Set memberID</div>
          <button id="memberCloseBtn" class="icon-btn" type="button" title="Close" aria-label="Close memberID dialog">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="setting-row">
            <div class="setting-desc">
              Choose an ID that we can later store in the database. Allowed: <b>A‚ÄìZ</b>, <b>0‚Äì9</b>, underscore <b>_</b>, dash <b>-</b>. Length: <b>3‚Äì20</b>.
            </div>
          </div>

          <div class="setting-row">
            <label class="setting-toggle" style="gap:10px; align-items:flex-start;">
              <span style="min-width:92px; font-weight:800;">memberID</span>
              <div style="flex:1;">
                <input id="memberIdInput" class="text-input" type="text" placeholder="e.g. Nico_01" autocomplete="off" />
                <div id="memberError" class="error" style="display:none; margin-top:8px;"></div>
                <div class="setting-desc" style="margin-top:8px;">Tip: keep it simple and unique for your Discord name.</div>
              </div>
            </label>
          </div>

          <div class="btn-row">
            <button id="memberClearBtn" class="delete-btn" type="button" title="Remove saved memberID">Clear</button>
            <button id="memberSaveBtn" type="button">Save</button>
          </div>
        </div>
      </div>
    </div>

<div id="bottom"></div>
  </div>

  <div class="scroll-fab" aria-label="Scroll navigation">
    <button id="toTopBtn" title="Back to Start">‚Üë</button>
    <button id="toBottomBtn" title="To Bottom">‚Üì</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    const STORAGE_KEY = "icao_checklist_data_v4"; 
    const THEME_KEY   = "icao_checklist_theme_v4";

    const MEMBER_ID_KEY = "ts3_member_id_v1";
    const app = document.getElementById("app");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const resetBtn = document.getElementById("resetBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const settingsCloseBtn = document.getElementById("settingsCloseBtn");
    const viewModeToggle = document.getElementById("viewModeToggle");
    const darkModeToggle = document.getElementById("darkModeToggle");

    // Share (Base64) UI in Settings
    const shareCodeOut = document.getElementById("shareCodeOut");
    const shareMeta = document.getElementById("shareMeta");
    const shareRefreshBtn = document.getElementById("shareRefreshBtn");
    const shareCopyBtn = document.getElementById("shareCopyBtn");
    const shareCodeIn = document.getElementById("shareCodeIn");
    const shareApplyMergeBtn = document.getElementById("shareApplyMergeBtn");
    const shareApplyReplaceBtn = document.getElementById("shareApplyReplaceBtn");
    const shareCompareBtn = document.getElementById("shareCompareBtn");
    const shareCompareOut = document.getElementById("shareCompareOut");


    const submitBtn = document.getElementById("submitBtn");
    const hideResultsBtn = document.getElementById("hideResultsBtn");
    const resultsEl = document.getElementById("results");
    const selectedCountText = document.getElementById("selectedCountText");

    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");
    const searchInfo = document.getElementById("searchInfo");

    const toTopBtn = document.getElementById("toTopBtn");
    const toBottomBtn = document.getElementById("toBottomBtn");


    const memberBtn = document.getElementById("memberBtn");
    const memberBadge = document.getElementById("memberBadge");
    const memberDisplay = document.getElementById("memberDisplay");
    const toastEl = document.getElementById("toast");
    const memberModal = document.getElementById("memberModal");
    const memberCloseBtn = document.getElementById("memberCloseBtn");
    const memberIdInput = document.getElementById("memberIdInput");
    const memberSaveBtn = document.getElementById("memberSaveBtn");
    const memberClearBtn = document.getElementById("memberClearBtn");
    const memberError = document.getElementById("memberError");
    function normalizeIcao(v) {
      return (v ?? "").toString().trim().toUpperCase();
    }


    let toastTimer = null;
    function showToast(message) {
      if (!toastEl) return;
      if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
      toastEl.textContent = message;
      toastEl.classList.add("show");
      toastTimer = setTimeout(() => {
        toastEl.classList.remove("show");
      }, 2200);
    }

    async function copyToClipboard(text) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch {}
      // Fallback
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      } catch {
        return false;
      }
    }

    function updateShareUI() {
      if (!shareCodeOut || !shareMeta) return;
      try {
        const code = encodeSelectionToShareCode();
        shareCodeOut.value = code;

        const selected = getSelectedSetFromState().size;
        const total = AIRPORT_CATALOG.length;
        const byteLen = Math.ceil(total / 8);
        shareMeta.textContent = `${selected}/${total} selected ‚Ä¢ ${AIRPORTS_VERSION} ‚Ä¢ ${byteLen} bytes`;
      } catch (e) {
        shareMeta.textContent = "‚Äî";
      }
    }


    // Builders
    function makeItems(codes) {
      return codes.map(code => ({ id: crypto.randomUUID(), text: normalizeIcao(code), done: false }));
    }
    function makeCountry(name, codes) {
      return { id: crypto.randomUUID(), title: name, collapsed: false, items: makeItems(codes) };
    }
    function cloneContinentFromDefaults(defCont) {
      return {
        id: crypto.randomUUID(),
        title: defCont.title,
        collapsed: false,
        groups: defCont.groups.map(g => makeCountry(g.title, g.items.map(i => i.text)))
      };
    }


    const demoData = [
      {
        id: crypto.randomUUID(),
        title: "North America",
        groups: [
          makeCountry("Canada", ["CYVR","CYYZ","CYTZ","CYUL"]),
          makeCountry("United States", [
            "KAUS","KATL","KBNA","KBOS","KBUR","KCLE","KCVG","KDAL","KDCA","KDEN","KDFW","KDTW","KEWR","KFLL",
            "KIAD","KIAH","KJFK","KLAS","KLAX","KLGA","KMCO","KONT","KORD","KPHL","KPIT","KPVD","KRDU","KRIC",
            "KSAN","KSEA","KSFO","KSLC","KSTL","KTUS",
            "PANC","Tist",              
            "KBWI","KEUG","KHOU","KIND","KLGB","KMCI","KMEM","KMIA","KMSP","KMSY","KPDX","KPHX","KRHV","PHKO"
          ]),
          makeCountry("Bermuda", ["TXKF"]),
          makeCountry("Sint Maarten", ["TNCM"])
        ]
      },
      {
        id: crypto.randomUUID(),
        title: "South America",
        groups: [
          makeCountry("Brazil", ["SBSP"]),
          makeCountry("Colombia", ["SKBO"])
        ]
      },
      {
        id: crypto.randomUUID(),
        title: "Europe",
        groups: [
          makeCountry("Belgium", ["EBBR"]),
          makeCountry("Germany", ["EDDF","EDDH","EDDK","EDDM","EDDS"]),
          makeCountry("United Kingdom", ["EGCC","EGKK","EGLL","EGNX"]),
          makeCountry("Austria", ["LOWW"]),
          makeCountry("Netherlands", ["EHAM"]),
          makeCountry("Denmark", ["EKCH"]),
          makeCountry("Norway", ["ENGM"]),
          makeCountry("Sweden", ["ESSA"]),
          makeCountry("Spain", ["LEBL"]),
          makeCountry("France", ["LFPG","LFPO","LFMT"]),
          makeCountry("Greece", ["LGAV"]),
          makeCountry("Italy", ["LIMC"]),
          makeCountry("Romania", ["LROP"]),
          makeCountry("Switzerland", ["LSZH","LSGG"]),
          makeCountry("Slovenia", ["LJLJ"]),
          makeCountry("Turkey", ["LTFM"])
        ]
      },
      {
        id: crypto.randomUUID(),
        title: "Asia",
        groups: [
          makeCountry("India", ["VIDP"]),
          makeCountry("Japan", ["RJTT","RJFF"]),
          makeCountry("United Arab Emirates", ["OMDB"]),
          makeCountry("Qatar", ["OTHH"]),
          makeCountry("Israel", ["LLBG"]),
          makeCountry("Hong Kong", ["VHHX"]),
          makeCountry("Macau", ["VMMC"]),
          makeCountry("Malaysia", ["WMMK"]),
          makeCountry("China", ["ZBAA","ZGSZ"]),
          makeCountry("Thailand", ["VTBS"]),
          makeCountry("Maldives", ["VRMM"])
        ]
      },
      {
        id: crypto.randomUUID(),
        title: "Oceania",
        groups: [
          makeCountry("Australia", ["YSSY"]),
          makeCountry("New Zealand", ["NZAA"]),
          makeCountry("Guam", ["PGUM"])
        ]
      },
      {
        id: crypto.randomUUID(),
        title: "Africa",
        groups: [
          makeCountry("South Africa", ["FAOR"])
        ]
      }
    ];
    // ===== Airport catalog for transferable Base64 codes =====
    // NOTE: The catalog is derived from the default demoData (stable list shipped with the app),
    // sorted lexicographically by ICAO code (A-Z). This keeps bit positions consistent across users.
    const AIRPORTS_VERSION = "A1"; // bump if the shipped airport catalog changes in a breaking way
    const AIRPORT_CATALOG = (() => {
      const set = new Set();
      for (const cont of demoData) {
        for (const country of (cont.groups || [])) {
          for (const item of (country.items || [])) {
            const code = normalizeIcao(item.text);
            if (code && code.length === 4) set.add(code);
          }
        }
      }
      return Array.from(set).sort();
    })();
    const ICAO_TO_INDEX = new Map(AIRPORT_CATALOG.map((c, i) => [c, i]));

    function bytesToBase64(bytes) {
      let bin = "";
      for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    }
    function base64ToBytes(b64) {
      const bin = atob(b64);
      const out = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i) & 255;
      return out;
    }
    function toBase64Url(b64) {
      return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }
    function fromBase64Url(b64url) {
      let b64 = b64url.replace(/-/g, "+").replace(/_/g, "/");
      const pad = b64.length % 4;
      if (pad === 2) b64 += "==";
      else if (pad === 3) b64 += "=";
      else if (pad !== 0) throw new Error("Invalid base64url length");
      return b64;
    }

    function getSelectedSetFromState() {
      const set = new Set();
      for (const cont of state) {
        for (const country of (cont.groups || [])) {
          for (const item of (country.items || [])) {
            const code = normalizeIcao(item.text);
            if (item.done && code && code.length === 4) set.add(code);
          }
        }
      }
      return set;
    }

    function encodeSelectionToShareCode() {
      const selected = getSelectedSetFromState();
      const byteLen = Math.ceil(AIRPORT_CATALOG.length / 8);
      const bytes = new Uint8Array(byteLen);

      for (let i = 0; i < AIRPORT_CATALOG.length; i++) {
        const code = AIRPORT_CATALOG[i];
        if (!selected.has(code)) continue;
        const bi = Math.floor(i / 8);
        const bit = i % 8;
        bytes[bi] |= (1 << bit); // LSB-first within each byte
      }

      const b64url = toBase64Url(bytesToBase64(bytes));
      return `${AIRPORTS_VERSION}.${b64url}`;
    }

    function decodeShareCodeToSet(rawCode) {
      if (!rawCode) throw new Error("Empty code");
      const trimmed = rawCode.trim();

      // Accept formats:
      //  - "A1.<base64url>" (recommended)
      //  - "<base64url>" (assumes current AIRPORTS_VERSION)
      let version = AIRPORTS_VERSION;
      let payload = trimmed;

      const dotIdx = trimmed.indexOf(".");
      if (dotIdx > 0) {
        version = trimmed.slice(0, dotIdx).trim();
        payload = trimmed.slice(dotIdx + 1).trim();
      }

      if (version !== AIRPORTS_VERSION) {
        throw new Error(`Version mismatch (got ${version}, need ${AIRPORTS_VERSION})`);
      }

      const b64 = fromBase64Url(payload);
      const bytes = base64ToBytes(b64);

      const expectedLen = Math.ceil(AIRPORT_CATALOG.length / 8);
      if (bytes.length !== expectedLen) {
        throw new Error(`Invalid code length (got ${bytes.length} bytes, expected ${expectedLen})`);
      }

      const set = new Set();
      for (let i = 0; i < AIRPORT_CATALOG.length; i++) {
        const bi = Math.floor(i / 8);
        const bit = i % 8;
        if ((bytes[bi] & (1 << bit)) !== 0) set.add(AIRPORT_CATALOG[i]);
      }
      return set;
    }

    function buildIcaoLocationMap() {
      // Uses current state first (so user-renamed continents/countries show correctly),
      // then falls back to demoData, otherwise "Unknown".
      const map = new Map();

      const ingest = (data) => {
        for (const cont of (data || [])) {
          const contName = (cont?.title ?? "").toString().trim() || "Unknown";
          for (const country of (cont?.groups || [])) {
            const countryName = (country?.title ?? "").toString().trim() || "Unknown";
            for (const item of (country?.items || [])) {
              const code = normalizeIcao(item?.text);
              if (code && code.length === 4 && !map.has(code)) {
                map.set(code, { continent: contName, country: countryName });
              }
            }
          }
        }
      };

      ingest(state);
      ingest(demoData);

      return map;
    }

    function renderCompareResult(commonSet, yourSetSize, otherSetSize) {
      if (!shareCompareOut) return;

      const total = commonSet.size;
      const locationMap = buildIcaoLocationMap();

      // Group: continent -> country -> codes[]
      const grouped = new Map();
      for (const code of Array.from(commonSet).sort()) {
        const loc = locationMap.get(code) || { continent: "Unknown", country: "Unknown" };
        if (!grouped.has(loc.continent)) grouped.set(loc.continent, new Map());
        const cm = grouped.get(loc.continent);
        if (!cm.has(loc.country)) cm.set(loc.country, []);
        cm.get(loc.country).push(code);
      }

      const wrapper = document.createElement("div");
      wrapper.className = "category";
      wrapper.style.margin = "0";
      wrapper.style.padding = "12px";

      const header = document.createElement("div");
      header.className = "results-title";
      const h2 = document.createElement("h2");
      h2.textContent = "Common airports";
      const meta = document.createElement("div");
      meta.className = "results-meta";
      meta.textContent = `${total} common ‚Ä¢ You: ${yourSetSize} ‚Ä¢ Code: ${otherSetSize}`;
      header.appendChild(h2);
      header.appendChild(meta);

      wrapper.appendChild(header);

      if (total === 0) {
        const note = document.createElement("div");
        note.className = "compare-note";
        note.textContent = "No matching airports between your selection and the pasted code.";
        wrapper.appendChild(note);
      } else {
        const grid = document.createElement("div");
        grid.className = "results-grid";

        for (const [continent, countryMap] of grouped.entries()) {
          for (const [country, codes] of countryMap.entries()) {
            const card = document.createElement("div");
            card.className = "country-card";

            const head = document.createElement("div");
            head.className = "country-card-head";

            const name = document.createElement("div");
            name.className = "name";
            name.textContent = `${continent} ‚Üí ${country}`;

            const count = document.createElement("div");
            count.className = "results-meta";
            count.textContent = `${codes.length}`;

            head.appendChild(name);
            head.appendChild(count);

            const chips = document.createElement("div");
            chips.className = "chips";
            for (const c of codes) {
              const chip = document.createElement("span");
              chip.className = "chip";
              chip.textContent = c;
              chips.appendChild(chip);
            }

            card.appendChild(head);
            card.appendChild(chips);
            grid.appendChild(card);
          }
        }

        wrapper.appendChild(grid);
      }

      shareCompareOut.innerHTML = "";
      shareCompareOut.style.display = "block";
      shareCompareOut.appendChild(wrapper);
    }

    function ensureImportedBucket() {
      let cont = state.find(c => (c.title || "").trim() === "Imported");
      if (!cont) {
        cont = { id: crypto.randomUUID(), title: "Imported", groups: [] };
        state.push(cont);
      }
      let country = (cont.groups || []).find(g => (g.title || "").trim() === "Unknown");
      if (!country) {
        country = { id: crypto.randomUUID(), title: "Unknown", items: [] };
        cont.groups.push(country);
      }
      return country;
    }

    function pruneEmptyImported() {
      // Remove the auto-created Imported ‚Üí Unknown bucket if it's empty
      const contIdx = state.findIndex(c => (c.title || "").trim() === "Imported");
      if (contIdx === -1) return;

      const cont = state[contIdx];
      if (!Array.isArray(cont.groups)) cont.groups = [];

      // Remove empty countries inside Imported
      cont.groups = cont.groups.filter(g => Array.isArray(g.items) && g.items.length > 0);

      // If nothing left, remove the whole Imported continent
      if (cont.groups.length === 0) state.splice(contIdx, 1);
    }

    function findItemByIcao(code) {
      const target = normalizeIcao(code);
      for (const cont of state) {
        for (const country of (cont.groups || [])) {
          for (const item of (country.items || [])) {
            if (normalizeIcao(item.text) === target) return item;
          }
        }
      }
      return null;
    }

    function applyShareCode(rawCode, mode) {
      // mode: "replace" | "merge"
      if (!rawCode) throw new Error("Empty code");
      const trimmed = rawCode.trim();

      // Accept formats:
      //  - "A1.<base64url>" (recommended)
      //  - "<base64url>" (assumes current AIRPORTS_VERSION)
      let version = AIRPORTS_VERSION;
      let payload = trimmed;

      const dotIdx = trimmed.indexOf(".");
      if (dotIdx > 0) {
        version = trimmed.slice(0, dotIdx).trim();
        payload = trimmed.slice(dotIdx + 1).trim();
      }

      if (version !== AIRPORTS_VERSION) {
        throw new Error(`Version mismatch (got ${version}, need ${AIRPORTS_VERSION})`);
      }

      const b64 = fromBase64Url(payload);
      const bytes = base64ToBytes(b64);

      const expectedLen = Math.ceil(AIRPORT_CATALOG.length / 8);
      if (bytes.length !== expectedLen) {
        throw new Error(`Invalid code length (got ${bytes.length} bytes, expected ${expectedLen})`);
      }

      if (mode === "replace") {
        // Clear all current checkmarks first
        for (const cont of state) {
          for (const country of (cont.groups || [])) {
            for (const item of (country.items || [])) {
              item.done = false;
            }
          }
        }
      }

      let importedCountry = null;

      for (let i = 0; i < AIRPORT_CATALOG.length; i++) {
        const bi = Math.floor(i / 8);
        const bit = i % 8;
        const isSet = (bytes[bi] & (1 << bit)) !== 0;
        if (!isSet) continue;

        const code = AIRPORT_CATALOG[i];
        let item = findItemByIcao(code);
        if (!item) {
          // user deleted it or doesn't have it locally: add under Imported ‚Üí Unknown
          if (!importedCountry) importedCountry = ensureImportedBucket();
          item = { id: crypto.randomUUID(), text: code, done: false };
          importedCountry.items.push(item);
        }
        item.done = true;
      }

      pruneEmptyImported();

      saveData();
      render();
      updateShareUI(); // refresh share code output
    }


    // Merge defaults into existing saved data without deleting anything.
    // Adds missing continents/countries/codes as unchecked items (keeps your current checkmarks).
    function mergeDefaultsIntoState(current, defaults) {
      const state = Array.isArray(current) ? current : [];

      const findByTitle = (arr, title) =>
        arr.find(x => (x?.title ?? "").toString().trim() === title);

      for (const defCont of defaults) {
        let cont = findByTitle(state, defCont.title);

        if (!cont) {
          state.push(cloneContinentFromDefaults(defCont));
          continue;
        }

        if (!Array.isArray(cont.groups)) cont.groups = [];

        for (const defGroup of defCont.groups) {
          let group = findByTitle(cont.groups, defGroup.title);

          if (!group) {
            cont.groups.push(makeCountry(defGroup.title, defGroup.items.map(i => i.text)));
            continue;
          }

          if (!Array.isArray(group.items)) group.items = [];

          const existingCodes = new Set(
            group.items.map(i => normalizeIcao(i.text)).filter(Boolean)
          );

          for (const defItem of defGroup.items) {
            const code = normalizeIcao(defItem.text);
            if (!code) continue;
            if (existingCodes.has(code)) continue;

            group.items.push({ id: crypto.randomUUID(), text: code, done: false });
            existingCodes.add(code);
          }
        }
      }

      return state;
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        let parsed = raw ? JSON.parse(raw) : structuredClone(demoData);
        if (!Array.isArray(parsed)) parsed = structuredClone(demoData);
        if (parsed.length && !parsed[0].groups) parsed = structuredClone(demoData);

        // Merge new airports in
        return mergeDefaultsIntoState(parsed, demoData);
      } catch {
        return structuredClone(demoData);
      }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateSelectedCount();
      buildSearchIndex();
      if (settingsModal && settingsModal.classList.contains("open")) updateShareUI();
    }

    function applyTheme(theme) {
      if (theme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
        darkModeToggle.checked = true;
      } else {
        document.documentElement.removeAttribute("data-theme");
        darkModeToggle.checked = false;
      }
    }

    function loadTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved) return saved;
      return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    }

    
    function normalizeCollapsedFlags(data){
      for (const cont of data){
        if (typeof cont.collapsed !== "boolean") cont.collapsed = false;
        if (!Array.isArray(cont.groups)) cont.groups = [];
        for (const g of cont.groups){
          if (typeof g.collapsed !== "boolean") g.collapsed = false;
          if (!Array.isArray(g.items)) g.items = [];
        }
      }
      return data;
    }

    
    function loadMemberId() {
      try {
        const v = localStorage.getItem(MEMBER_ID_KEY);
        return v ? v : "";
      } catch { return ""; }
    }

    function setMemberId(value) {
      const v = (value ?? "").toString().trim();
      if (!v) {
        localStorage.removeItem(MEMBER_ID_KEY);
      } else {
        localStorage.setItem(MEMBER_ID_KEY, v);
      }
      updateMemberUi();
    }

    function updateMemberUi() {
      const current = loadMemberId();
      if (memberBtn) {
        memberBtn.title = current ? `memberID: ${current}` : "Set memberID";
      }
      if (memberBadge) {
        memberBadge.classList.toggle("on", !!current);
      }
      if (memberDisplay) {
        memberDisplay.textContent = current ? `ID: ${current}` : "";
        memberDisplay.classList.toggle("on", !!current);
      }
      if (memberIdInput) {
        memberIdInput.value = current || "";
      }
    }

    function validateMemberId(v) {
      const s = (v ?? "").toString().trim();
      if (!s) return { ok: false, msg: "Please enter a memberID." };
      if (s.length < 3 || s.length > 20) return { ok: false, msg: "Length must be 3‚Äì20 characters." };
      if (!/^[A-Za-z0-9_-]+$/.test(s)) return { ok: false, msg: "Allowed characters: A‚ÄìZ, 0‚Äì9, _ and -." };
      return { ok: true, value: s };
    }

    function showMemberError(msg) {
      if (!memberError) return;
      if (!msg) {
        memberError.style.display = "none";
        memberError.textContent = "";
      } else {
        memberError.style.display = "block";
        memberError.textContent = msg;
      }
    }

    function openMemberModal() {
      if (!memberModal) return;
      showMemberError("");
      updateMemberUi();
      memberModal.classList.add("open");
      memberModal.setAttribute("aria-hidden", "false");
      if (memberBtn) memberBtn.setAttribute("aria-expanded", "true");
      document.body.classList.add("modal-open");
      // focus input
      setTimeout(() => memberIdInput && memberIdInput.focus(), 0);
    }

    function closeMemberModal() {
      if (!memberModal) return;
      memberModal.classList.remove("open");
      memberModal.setAttribute("aria-hidden", "true");
      if (memberBtn) memberBtn.setAttribute("aria-expanded", "false");
      document.body.classList.remove("modal-open");
      showMemberError("");
    }

let state = normalizeCollapsedFlags(loadData());

    
    function getContinentStats(continent){
      let total = 0, selected = 0;
      for (const country of (continent.groups || [])){
        for (const item of (country.items || [])){
          const hasCode = !!normalizeIcao(item.text);
          if (!hasCode) continue;
          total++;
          if (item.done) selected++;
        }
      }
      return { total, selected };
    }

    function getCountryStats(country){
      let total = 0, selected = 0;
      for (const item of (country.items || [])){
        const hasCode = !!normalizeIcao(item.text);
        if (!hasCode) continue;
        total++;
        if (item.done) selected++;
      }
      return { total, selected };
    }

    function findPathByItemId(itemId){
      for (const cont of state){
        for (const group of (cont.groups || [])){
          for (const item of (group.items || [])){
            if (item.id === itemId) return { cont, group };
          }
        }
      }
      return null;
    }

    function ensureExpandedForItemId(itemId){
      const path = findPathByItemId(itemId);
      if (!path) return false;
      let changed = false;
      if (path.cont.collapsed){
        path.cont.collapsed = false;
        changed = true;
      }
      if (path.group.collapsed){
        path.group.collapsed = false;
        changed = true;
      }
      return changed;
    }

    function insertItemAfter(group, itemIndex) {
      if (group.collapsed){
        group.collapsed = false;
      }
      const newId = crypto.randomUUID();
      group.items.splice(itemIndex + 1, 0, { id: newId, text: "", done: false });
      saveData();
      render({ focusItemId: newId, skipSearch: true });
    }

    function render(opts = {}) {
      app.innerHTML = "";
      const readOnly = viewModeToggle.checked;

      state.forEach(continent => {
        const section = document.createElement("section");
        section.className = "category";
        if (continent.collapsed) section.classList.add("collapsed");

        const head = document.createElement("div");
        head.className = "cat-head";

        // Left side: collapse + title + meta
        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";
        left.style.flex = "1";

        const collapseBtn = document.createElement("button");
        collapseBtn.type = "button";
        collapseBtn.className = "icon-btn collapse-btn";
        collapseBtn.title = continent.collapsed ? "Expand" : "Collapse";
        collapseBtn.setAttribute("aria-label", continent.collapsed ? "Expand continent" : "Collapse continent");
        collapseBtn.innerHTML = '<span class="chev">‚ñæ</span>';
        collapseBtn.addEventListener("click", () => {
          continent.collapsed = !continent.collapsed;
          saveData();
          render({ skipSearch: true });
        });

        const titleInput = document.createElement("input");
        titleInput.className = "cat-title";
        titleInput.value = continent.title;
        titleInput.disabled = readOnly;
        titleInput.addEventListener("input", () => {
          continent.title = titleInput.value;
          saveData();
        });

        const stats = getContinentStats(continent);
        const pill = document.createElement("div");
        pill.className = "meta-pill";
        pill.textContent = stats.total ? `${stats.selected}/${stats.total}` : "0";
        pill.title = "Selected / Total";

        left.appendChild(collapseBtn);
        left.appendChild(titleInput);
        left.appendChild(pill);

        const actions = document.createElement("div");
        actions.className = "cat-actions";

        const addCountryBtn = document.createElement("button");
        addCountryBtn.textContent = "+ Country";
        addCountryBtn.disabled = readOnly;
        addCountryBtn.addEventListener("click", () => {
          const newItemId = crypto.randomUUID();
          continent.collapsed = false;
          continent.groups.push({
            id: crypto.randomUUID(),
            title: "New Country",
            collapsed: false,
            items: [{ id: newItemId, text: "", done: false }]
          });
          saveData();
          render({ focusItemId: newItemId, skipSearch: true });
        });

        const delContBtn = document.createElement("button");
        delContBtn.textContent = "Delete Continent";
        delContBtn.className = "delete-btn";
        delContBtn.disabled = readOnly;
        delContBtn.addEventListener("click", () => {
          state = state.filter(c => c.id !== continent.id);
          saveData();
          render({ skipSearch: true });
        });

        actions.appendChild(addCountryBtn);
        actions.appendChild(delContBtn);

        head.appendChild(left);
        head.appendChild(actions);
        section.appendChild(head);

        const body = document.createElement("div");
        body.className = "collapsible-body";

        (continent.groups || []).forEach(group => {
          const sub = document.createElement("div");
          sub.className = "subcat";
          if (group.collapsed) sub.classList.add("collapsed");

          const subHead = document.createElement("div");
          subHead.className = "subcat-head";

          const subLeft = document.createElement("div");
          subLeft.style.display = "flex";
          subLeft.style.alignItems = "center";
          subLeft.style.gap = "10px";
          subLeft.style.flex = "1";

          const groupCollapseBtn = document.createElement("button");
          groupCollapseBtn.type = "button";
          groupCollapseBtn.className = "icon-btn collapse-btn";
          groupCollapseBtn.title = group.collapsed ? "Expand" : "Collapse";
          groupCollapseBtn.setAttribute("aria-label", group.collapsed ? "Expand country" : "Collapse country");
          groupCollapseBtn.innerHTML = '<span class="chev">‚ñæ</span>';
          groupCollapseBtn.addEventListener("click", () => {
            group.collapsed = !group.collapsed;
            saveData();
            render({ skipSearch: true });
          });

          const subTitle = document.createElement("input");
          subTitle.className = "subcat-title";
          subTitle.value = group.title;
          subTitle.disabled = readOnly;
          subTitle.addEventListener("input", () => {
            group.title = subTitle.value;
            saveData();
          });

          const gStats = getCountryStats(group);
          const gPill = document.createElement("div");
          gPill.className = "meta-pill";
          gPill.textContent = gStats.total ? `${gStats.selected}/${gStats.total}` : "0";
          gPill.title = "Selected / Total";

          subLeft.appendChild(groupCollapseBtn);
          subLeft.appendChild(subTitle);
          subLeft.appendChild(gPill);

          const subActions = document.createElement("div");
          subActions.className = "subcat-actions";

          const addItemBtn = document.createElement("button");
          addItemBtn.textContent = "+ Airport";
          addItemBtn.disabled = readOnly;
          addItemBtn.addEventListener("click", () => {
            const newId = crypto.randomUUID();
            group.collapsed = false;
            group.items.push({ id: newId, text: "", done: false });
            saveData();
            render({ focusItemId: newId, skipSearch: true });
          });

          const delCountryBtn = document.createElement("button");
          delCountryBtn.textContent = "Delete country";
          delCountryBtn.className = "delete-btn";
          delCountryBtn.disabled = readOnly;
          delCountryBtn.addEventListener("click", () => {
            continent.groups = continent.groups.filter(g => g.id !== group.id);
            saveData();
            render({ skipSearch: true });
          });

          subActions.appendChild(addItemBtn);
          subActions.appendChild(delCountryBtn);

          subHead.appendChild(subLeft);
          subHead.appendChild(subActions);
          sub.appendChild(subHead);

          const subBody = document.createElement("div");
          subBody.className = "collapsible-body";

          (group.items || []).forEach((item, idx) => {
            const row = document.createElement("div");
            row.className = "item";
            row.dataset.itemId = item.id;

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = !!item.done;
            cb.disabled = readOnly;
            cb.addEventListener("change", () => {
              item.done = cb.checked;
              saveData();
            });

            const text = document.createElement("input");
            text.className = "item-text";
            text.value = item.text;
            text.disabled = readOnly;
            text.dataset.itemId = item.id;

            text.addEventListener("input", () => {
              const normalized = normalizeIcao(text.value);
              item.text = normalized;
              if (text.value !== normalized) text.value = normalized;
              saveData();
            });

            text.addEventListener("keydown", (e) => {
              if (readOnly) return;
              if (e.key === "Enter") {
                e.preventDefault();
                insertItemAfter(group, idx);
              }
            });

            const delItemBtn = document.createElement("button");
            delItemBtn.textContent = "Delete";
            delItemBtn.className = "delete-btn";
            delItemBtn.disabled = readOnly;
            delItemBtn.addEventListener("click", () => {
              group.items = group.items.filter(i => i.id !== item.id);
              saveData();
              render({ skipSearch: true });
            });

            row.appendChild(cb);
            row.appendChild(text);
            row.appendChild(delItemBtn);
            subBody.appendChild(row);
          });

          sub.appendChild(subBody);
          body.appendChild(sub);
        });

        section.appendChild(body);
        app.appendChild(section);
      });

      if (opts.focusItemId) {
        const el = app.querySelector(`input.item-text[data-item-id="${opts.focusItemId}"]`);
        if (el) el.focus();
      }

      updateSelectedCount();
      buildSearchIndex();

      if (!opts.skipSearch) {
        maybeSearch(searchInput.value, { silent: true });
      }
    }

    function countSelected() {
      let n = 0;
      for (const cont of state) for (const country of cont.groups)
        for (const item of country.items)
          if (item.done && normalizeIcao(item.text)) n++;
      return n;
    }

    function updateSelectedCount() {
      const n = countSelected();
      selectedCountText.textContent = n ? `Currently selected: ${n}` : "";
    }

    function getSelectedStructured() {
      const out = [];
      for (const cont of state) {
        const countries = [];
        for (const country of cont.groups) {
          const codes = country.items
            .filter(i => i.done && normalizeIcao(i.text))
            .map(i => normalizeIcao(i.text));
          if (codes.length) {
            const uniqueSorted = Array.from(new Set(codes)).sort();
            countries.push({ title: country.title, codes: uniqueSorted });
          }
        }
        if (countries.length) {
          countries.sort((a,b) => a.title.localeCompare(b.title));
          out.push({ title: cont.title, countries });
        }
      }
      out.sort((a,b) => a.title.localeCompare(b.title));
      return out;
    }

    function renderResults() {
      const structured = getSelectedStructured();
      resultsEl.innerHTML = "";

      const total = countSelected();

      const card = document.createElement("section");
      card.className = "category";

      const header = document.createElement("div");
      header.className = "results-title";

      const h2 = document.createElement("h2");
      h2.textContent = `Selected airports (${total})`;

      const meta = document.createElement("div");
      meta.className = "results-meta";
      meta.textContent = total
        ? "Continent ‚Üí Country ‚Üí ICAO"
        : "No airports selected yet.";

      header.appendChild(h2);
      header.appendChild(meta);
      card.appendChild(header);

      if (!total) {
        const p = document.createElement("div");
        p.className = "empty";
        p.textContent = "Check Airports and then press Submit to see the compact list.";
        card.appendChild(p);
      } else {
        structured.forEach(cont => {
          const contSub = document.createElement("div");
          contSub.className = "subcat";

          const contHead = document.createElement("div");
          contHead.className = "subcat-head";

          const contTitle = document.createElement("div");
          contTitle.className = "subcat-title";
          contTitle.style.fontWeight = "800";
          contTitle.textContent = cont.title;

          const contCount = cont.countries.reduce((acc, c) => acc + c.codes.length, 0);
          const contMeta = document.createElement("div");
          contMeta.className = "results-meta";
          contMeta.textContent = `${contCount}`;

          contHead.appendChild(contTitle);
          contHead.appendChild(contMeta);
          contSub.appendChild(contHead);

          const grid = document.createElement("div");
          grid.className = "results-grid";

          cont.countries.forEach(country => {
            const c = document.createElement("div");
            c.className = "country-card";

            const cHead = document.createElement("div");
            cHead.className = "country-card-head";

            const name = document.createElement("div");
            name.className = "name";
            name.textContent = country.title;

            const count = document.createElement("div");
            count.className = "results-meta";
            count.textContent = `${country.codes.length}`;

            cHead.appendChild(name);
            cHead.appendChild(count);

            const chips = document.createElement("div");
            chips.className = "chips";
            country.codes.forEach(code => {
              const chip = document.createElement("span");
              chip.className = "chip";
              chip.textContent = code;
              chips.appendChild(chip);
            });

            c.appendChild(cHead);
            c.appendChild(chips);
            grid.appendChild(c);
          });

          contSub.appendChild(grid);
          card.appendChild(contSub);
        });
      }

      resultsEl.appendChild(card);
      hideResultsBtn.style.display = "inline-flex";
      card.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    hideResultsBtn.addEventListener("click", () => {
      resultsEl.innerHTML = "";
      hideResultsBtn.style.display = "none";
      updateSelectedCount();
    });

    // ===== SEARCH =====
    let searchIndex = [];
    let matches = [];
    let matchPos = -1;

    function buildSearchIndex() {
      searchIndex = [];
      const inputs = app.querySelectorAll("input.item-text[data-item-id]");
      inputs.forEach(inp => {
        const icao = normalizeIcao(inp.value);
        if (icao) searchIndex.push({ icao, itemId: inp.dataset.itemId });
      });
    }

    function clearHighlight() {
      const prev = app.querySelector(".jump-highlight");
      if (prev) prev.classList.remove("jump-highlight");
    }

    function jumpToItemId(itemId) {
      // Ensure the continent/country containing this item is expanded
      const changed = ensureExpandedForItemId(itemId);
      if (changed) {
        saveData();
        render({ skipSearch: true });
        // Wait for DOM to rebuild, then jump again
        setTimeout(() => jumpToItemId(itemId), 0);
        return;
      }

      clearHighlight();
      const row = app.querySelector(`.item[data-item-id="${itemId}"]`);
      if (row) {
        row.classList.add("jump-highlight");
        row.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => row.classList.remove("jump-highlight"), 2200);
      }
    }

    function maybeSearch(query, { silent = false } = {}) {
      const q = normalizeIcao(query);

      // only jump when 4 chars entered (ICAO length)
      if (q.length < 4) {
        matches = [];
        matchPos = -1;
        clearHighlight();
        if (!silent) {
          if (!q.length) searchInfo.textContent = "";
          else searchInfo.textContent = "Please enter 4 letters‚Ä¶";
        } else {
          if (!q.length) searchInfo.textContent = "";
          else searchInfo.textContent = "Please enter 4 letters‚Ä¶";
        }
        return;
      }

      matches = searchIndex.filter(x => x.icao.includes(q)).map(x => x.itemId);
      matches = Array.from(new Set(matches));

      if (!matches.length) {
        matchPos = -1;
        clearHighlight();
        searchInfo.textContent = `Keine Treffer f√ºr "${q}"`;
        return;
      }

      matchPos = 0;
      searchInfo.textContent = `${matchPos + 1}/${matches.length} Treffer f√ºr "${q}"`;
      jumpToItemId(matches[matchPos]);
    }

    function nextMatch() {
      if (!matches.length) return;
      matchPos = (matchPos + 1) % matches.length;
      searchInfo.textContent = `${matchPos + 1}/${matches.length} Treffer`;
      jumpToItemId(matches[matchPos]);
    }

    function prevMatch() {
      if (!matches.length) return;
      matchPos = (matchPos - 1 + matches.length) % matches.length;
      searchInfo.textContent = `${matchPos + 1}/${matches.length} Treffer`;
      jumpToItemId(matches[matchPos]);
    }

    searchBtn.addEventListener("click", () => maybeSearch(searchInput.value));
    nextBtn.addEventListener("click", () => {
      if (normalizeIcao(searchInput.value).length < 4) { searchInfo.textContent = "Bitte 4 Buchstaben eingeben‚Ä¶"; return; }
      nextMatch();
    });
    prevBtn.addEventListener("click", () => {
      if (normalizeIcao(searchInput.value).length < 4) { searchInfo.textContent = "Bitte 4 Buchstaben eingeben‚Ä¶"; return; }
      prevMatch();
    });

    searchInput.addEventListener("input", () => {
      if (searchInput._t) clearTimeout(searchInput._t);
      searchInput._t = setTimeout(() => maybeSearch(searchInput.value), 200);
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); maybeSearch(searchInput.value); }
      if (e.key === "ArrowDown") nextMatch();
      if (e.key === "ArrowUp") prevMatch();
      if (e.key === "Escape") { searchInput.value = ""; maybeSearch("", { silent:true }); }
    });

    // ===== Scroll buttons =====
    toTopBtn.addEventListener("click", () => {
      document.getElementById("top").scrollIntoView({ behavior:"smooth", block:"start" });
    });
    toBottomBtn.addEventListener("click", () => {
      document.getElementById("bottom").scrollIntoView({ behavior:"smooth", block:"end" });
    });

    // ===== Toolbar actions =====
    addCategoryBtn.addEventListener("click", () => {
      const newItemId = crypto.randomUUID();
      state.push({
        id: crypto.randomUUID(),
        title: "new Continent",
        collapsed: false,
        groups: [
          { id: crypto.randomUUID(), title: "New Country", collapsed: false, items: [{ id: newItemId, text: "", done: false }] }
        ]
      });
      saveData();
      render({ focusItemId: newItemId });
    });

    resetBtn.addEventListener("click", () => {
      state = normalizeCollapsedFlags(structuredClone(demoData));
      localStorage.removeItem(STORAGE_KEY);
      saveData();
      render();
      resultsEl.innerHTML = "";
      hideResultsBtn.style.display = "none";
      searchInput.value = "";
      maybeSearch("", { silent:true });
    });

    viewModeToggle.addEventListener("change", render);

    darkModeToggle.addEventListener("change", () => {
      const theme = darkModeToggle.checked ? "dark" : "light";
      localStorage.setItem(THEME_KEY, theme);
      applyTheme(theme);
    });

    // Settings modal
    
    // ===== memberID modal =====
    if (memberBtn) memberBtn.addEventListener("click", openMemberModal);
    if (memberCloseBtn) memberCloseBtn.addEventListener("click", closeMemberModal);

    if (memberModal) {
      memberModal.addEventListener("click", (e) => {
        if (e.target === memberModal) closeMemberModal();
      });
    }

    if (memberSaveBtn) {
      memberSaveBtn.addEventListener("click", () => {
        const res = validateMemberId(memberIdInput ? memberIdInput.value : "");
        if (!res.ok) { showMemberError(res.msg); return; }
        setMemberId(res.value);
        showToast(`memberID saved: ${res.value}`);
        closeMemberModal();
      });
    }

    if (memberClearBtn) {
      memberClearBtn.addEventListener("click", () => {
        setMemberId("");
        showToast("memberID cleared");
        closeMemberModal();
      });
    }

    if (memberIdInput) {
      memberIdInput.addEventListener("input", () => showMemberError(""));
      memberIdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          if (memberSaveBtn) memberSaveBtn.click();
        }
      });
    }


function openSettings() {
      if (!settingsModal) return;
      settingsModal.classList.add("open");
      settingsModal.setAttribute("aria-hidden", "false");
      if (settingsBtn) settingsBtn.setAttribute("aria-expanded", "true");
      document.body.classList.add("modal-open");
    }

    function closeSettings() {
      if (!settingsModal) return;
      settingsModal.classList.remove("open");
      settingsModal.setAttribute("aria-hidden", "true");
      if (settingsBtn) settingsBtn.setAttribute("aria-expanded", "false");
      document.body.classList.remove("modal-open");
    }

    if (settingsBtn) settingsBtn.addEventListener("click", openSettings);
    if (settingsCloseBtn) settingsCloseBtn.addEventListener("click", closeSettings);

    if (settingsModal) {
      settingsModal.addEventListener("click", (e) => {
        // click outside the card closes
        if (e.target === settingsModal) closeSettings();
      });
    }

    
    // Share (Base64) actions
    if (shareRefreshBtn) {
      shareRefreshBtn.addEventListener("click", () => {
        updateShareUI();
        showToast("Share code updated.");
      });
    }
    if (shareCopyBtn) {
      shareCopyBtn.addEventListener("click", async () => {
        const code = (shareCodeOut && shareCodeOut.value) ? shareCodeOut.value.trim() : "";
        if (!code) { showToast("Nothing to copy."); return; }
        const ok = await copyToClipboard(code);
        showToast(ok ? "Copied share code." : "Copy failed.");
      });
    }
    if (shareApplyMergeBtn) {
      shareApplyMergeBtn.addEventListener("click", () => {
        try {
          applyShareCode(shareCodeIn ? shareCodeIn.value : "", "merge");
          showToast("Applied code (merge).");
        } catch (e) {
          showToast(e?.message ? `Error: ${e.message}` : "Error applying code.");
        }
      });
    }
    if (shareApplyReplaceBtn) {
      shareApplyReplaceBtn.addEventListener("click", () => {
        try {
          applyShareCode(shareCodeIn ? shareCodeIn.value : "", "replace");
          showToast("Applied code (replace).");
        } catch (e) {
          showToast(e?.message ? `Error: ${e.message}` : "Error applying code.");
        }
      });
    }


    if (shareCompareBtn) {
      shareCompareBtn.addEventListener("click", () => {
        try {
          const otherSet = decodeShareCodeToSet(shareCodeIn ? shareCodeIn.value : "");
          const yourSet = getSelectedSetFromState();
          const common = new Set();
          for (const c of otherSet) if (yourSet.has(c)) common.add(c);

          renderCompareResult(common, yourSet.size, otherSet.size);
          showToast(common.size ? `Found ${common.size} common airports.` : "No common airports.");
        } catch (e) {
          if (shareCompareOut) { shareCompareOut.style.display = "none"; shareCompareOut.innerHTML = ""; }
          showToast(e?.message ? `Error: ${e.message}` : "Error comparing code.");
        }
      });
    }

    if (shareCodeIn) {
      shareCodeIn.addEventListener("input", () => {
        // hide stale compare output while typing/changing the code
        if (shareCompareOut) { shareCompareOut.style.display = "none"; shareCompareOut.innerHTML = ""; }
      });
    }

document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (memberModal && memberModal.classList.contains("open")) closeMemberModal();
        if (settingsModal && settingsModal.classList.contains("open")) closeSettings();
      }
    });
submitBtn.addEventListener("click", renderResults);

    // Initial
    applyTheme(loadTheme());
    updateMemberUi();
    saveData();
    render();
  </script>
</body>
</html>

  </script>
</body>
</html>
